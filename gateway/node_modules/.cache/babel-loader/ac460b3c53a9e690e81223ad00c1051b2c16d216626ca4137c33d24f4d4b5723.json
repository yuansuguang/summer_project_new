{"ast":null,"code":"import Base from '../core/Base';\nimport Vector3 from '../math/Vector3';\nimport PerspectiveCamera from '../camera/Perspective';\nimport FrameBuffer from '../FrameBuffer';\nvar targets = ['px', 'nx', 'py', 'ny', 'pz', 'nz'];\n\n/**\n * Pass rendering scene to a environment cube map\n *\n * @constructor clay.prePass.EnvironmentMap\n * @extends clay.core.Base\n * @example\n *     // Example of car reflection\n *     var envMap = new clay.TextureCube({\n *         width: 256,\n *         height: 256\n *     });\n *     var envPass = new clay.prePass.EnvironmentMap({\n *         position: car.position,\n *         texture: envMap\n *     });\n *     var carBody = car.getChildByName('body');\n *     carBody.material.enableTexture('environmentMap');\n *     carBody.material.set('environmentMap', envMap);\n *     ...\n *     animation.on('frame', function(frameTime) {\n *         envPass.render(renderer, scene);\n *         renderer.render(scene, camera);\n *     });\n */\nvar EnvironmentMapPass = Base.extend(function () {\n  var ret = /** @lends clay.prePass.EnvironmentMap# */{\n    /**\n     * Camera position\n     * @type {clay.Vector3}\n     * @memberOf clay.prePass.EnvironmentMap#\n     */\n    position: new Vector3(),\n    /**\n     * Camera far plane\n     * @type {number}\n     * @memberOf clay.prePass.EnvironmentMap#\n     */\n    far: 1000,\n    /**\n     * Camera near plane\n     * @type {number}\n     * @memberOf clay.prePass.EnvironmentMap#\n     */\n    near: 0.1,\n    /**\n     * Environment cube map\n     * @type {clay.TextureCube}\n     * @memberOf clay.prePass.EnvironmentMap#\n     */\n    texture: null,\n    /**\n     * Used if you wan't have shadow in environment map\n     * @type {clay.prePass.ShadowMap}\n     */\n    shadowMapPass: null\n  };\n  var cameras = ret._cameras = {\n    px: new PerspectiveCamera({\n      fov: 90\n    }),\n    nx: new PerspectiveCamera({\n      fov: 90\n    }),\n    py: new PerspectiveCamera({\n      fov: 90\n    }),\n    ny: new PerspectiveCamera({\n      fov: 90\n    }),\n    pz: new PerspectiveCamera({\n      fov: 90\n    }),\n    nz: new PerspectiveCamera({\n      fov: 90\n    })\n  };\n  cameras.px.lookAt(Vector3.POSITIVE_X, Vector3.NEGATIVE_Y);\n  cameras.nx.lookAt(Vector3.NEGATIVE_X, Vector3.NEGATIVE_Y);\n  cameras.py.lookAt(Vector3.POSITIVE_Y, Vector3.POSITIVE_Z);\n  cameras.ny.lookAt(Vector3.NEGATIVE_Y, Vector3.NEGATIVE_Z);\n  cameras.pz.lookAt(Vector3.POSITIVE_Z, Vector3.NEGATIVE_Y);\n  cameras.nz.lookAt(Vector3.NEGATIVE_Z, Vector3.NEGATIVE_Y);\n\n  // FIXME In windows, use one framebuffer only renders one side of cubemap\n  ret._frameBuffer = new FrameBuffer();\n  return ret;\n}, /** @lends clay.prePass.EnvironmentMap# */{\n  /**\n   * @param  {string} target\n   * @return  {clay.Camera}\n   */\n  getCamera: function (target) {\n    return this._cameras[target];\n  },\n  /**\n   * @param  {clay.Renderer} renderer\n   * @param  {clay.Scene} scene\n   * @param  {boolean} [notUpdateScene=false]\n   */\n  render: function (renderer, scene, notUpdateScene) {\n    var _gl = renderer.gl;\n    if (!notUpdateScene) {\n      scene.update();\n    }\n    // Tweak fov\n    // http://the-witness.net/news/2012/02/seamless-cube-map-filtering/\n    var n = this.texture.width;\n    var fov = 2 * Math.atan(n / (n - 0.5)) / Math.PI * 180;\n    for (var i = 0; i < 6; i++) {\n      var target = targets[i];\n      var camera = this._cameras[target];\n      Vector3.copy(camera.position, this.position);\n      camera.far = this.far;\n      camera.near = this.near;\n      camera.fov = fov;\n      if (this.shadowMapPass) {\n        camera.update();\n\n        // update boundingBoxLastFrame\n        var bbox = scene.getBoundingBox();\n        bbox.applyTransform(camera.viewMatrix);\n        scene.viewBoundingBoxLastFrame.copy(bbox);\n        this.shadowMapPass.render(renderer, scene, camera, true);\n      }\n      this._frameBuffer.attach(this.texture, _gl.COLOR_ATTACHMENT0, _gl.TEXTURE_CUBE_MAP_POSITIVE_X + i);\n      this._frameBuffer.bind(renderer);\n      renderer.render(scene, camera, true);\n      this._frameBuffer.unbind(renderer);\n    }\n  },\n  /**\n   * @param {clay.Renderer} renderer\n   */\n  dispose: function (renderer) {\n    this._frameBuffer.dispose(renderer);\n  }\n});\nexport default EnvironmentMapPass;","map":{"version":3,"names":["Base","Vector3","PerspectiveCamera","FrameBuffer","targets","EnvironmentMapPass","extend","ret","position","far","near","texture","shadowMapPass","cameras","_cameras","px","fov","nx","py","ny","pz","nz","lookAt","POSITIVE_X","NEGATIVE_Y","NEGATIVE_X","POSITIVE_Y","POSITIVE_Z","NEGATIVE_Z","_frameBuffer","getCamera","target","render","renderer","scene","notUpdateScene","_gl","gl","update","n","width","Math","atan","PI","i","camera","copy","bbox","getBoundingBox","applyTransform","viewMatrix","viewBoundingBoxLastFrame","attach","COLOR_ATTACHMENT0","TEXTURE_CUBE_MAP_POSITIVE_X","bind","unbind","dispose"],"sources":["E:/mytest/node_modules/claygl/src/prePass/EnvironmentMap.js"],"sourcesContent":["import Base from '../core/Base';\nimport Vector3 from '../math/Vector3';\nimport PerspectiveCamera from '../camera/Perspective';\nimport FrameBuffer from '../FrameBuffer';\n\nvar targets = ['px', 'nx', 'py', 'ny', 'pz', 'nz'];\n\n/**\n * Pass rendering scene to a environment cube map\n *\n * @constructor clay.prePass.EnvironmentMap\n * @extends clay.core.Base\n * @example\n *     // Example of car reflection\n *     var envMap = new clay.TextureCube({\n *         width: 256,\n *         height: 256\n *     });\n *     var envPass = new clay.prePass.EnvironmentMap({\n *         position: car.position,\n *         texture: envMap\n *     });\n *     var carBody = car.getChildByName('body');\n *     carBody.material.enableTexture('environmentMap');\n *     carBody.material.set('environmentMap', envMap);\n *     ...\n *     animation.on('frame', function(frameTime) {\n *         envPass.render(renderer, scene);\n *         renderer.render(scene, camera);\n *     });\n */\nvar EnvironmentMapPass = Base.extend(function() {\n    var ret = /** @lends clay.prePass.EnvironmentMap# */ {\n        /**\n         * Camera position\n         * @type {clay.Vector3}\n         * @memberOf clay.prePass.EnvironmentMap#\n         */\n        position: new Vector3(),\n        /**\n         * Camera far plane\n         * @type {number}\n         * @memberOf clay.prePass.EnvironmentMap#\n         */\n        far: 1000,\n        /**\n         * Camera near plane\n         * @type {number}\n         * @memberOf clay.prePass.EnvironmentMap#\n         */\n        near: 0.1,\n        /**\n         * Environment cube map\n         * @type {clay.TextureCube}\n         * @memberOf clay.prePass.EnvironmentMap#\n         */\n        texture: null,\n\n        /**\n         * Used if you wan't have shadow in environment map\n         * @type {clay.prePass.ShadowMap}\n         */\n        shadowMapPass: null,\n    };\n    var cameras = ret._cameras = {\n        px: new PerspectiveCamera({ fov: 90 }),\n        nx: new PerspectiveCamera({ fov: 90 }),\n        py: new PerspectiveCamera({ fov: 90 }),\n        ny: new PerspectiveCamera({ fov: 90 }),\n        pz: new PerspectiveCamera({ fov: 90 }),\n        nz: new PerspectiveCamera({ fov: 90 })\n    };\n    cameras.px.lookAt(Vector3.POSITIVE_X, Vector3.NEGATIVE_Y);\n    cameras.nx.lookAt(Vector3.NEGATIVE_X, Vector3.NEGATIVE_Y);\n    cameras.py.lookAt(Vector3.POSITIVE_Y, Vector3.POSITIVE_Z);\n    cameras.ny.lookAt(Vector3.NEGATIVE_Y, Vector3.NEGATIVE_Z);\n    cameras.pz.lookAt(Vector3.POSITIVE_Z, Vector3.NEGATIVE_Y);\n    cameras.nz.lookAt(Vector3.NEGATIVE_Z, Vector3.NEGATIVE_Y);\n\n    // FIXME In windows, use one framebuffer only renders one side of cubemap\n    ret._frameBuffer = new FrameBuffer();\n\n    return ret;\n},  /** @lends clay.prePass.EnvironmentMap# */ {\n    /**\n     * @param  {string} target\n     * @return  {clay.Camera}\n     */\n    getCamera: function (target) {\n        return this._cameras[target];\n    },\n    /**\n     * @param  {clay.Renderer} renderer\n     * @param  {clay.Scene} scene\n     * @param  {boolean} [notUpdateScene=false]\n     */\n    render: function(renderer, scene, notUpdateScene) {\n        var _gl = renderer.gl;\n        if (!notUpdateScene) {\n            scene.update();\n        }\n        // Tweak fov\n        // http://the-witness.net/news/2012/02/seamless-cube-map-filtering/\n        var n = this.texture.width;\n        var fov = 2 * Math.atan(n / (n - 0.5)) / Math.PI * 180;\n\n        for (var i = 0; i < 6; i++) {\n            var target = targets[i];\n            var camera = this._cameras[target];\n            Vector3.copy(camera.position, this.position);\n\n            camera.far = this.far;\n            camera.near = this.near;\n            camera.fov = fov;\n\n            if (this.shadowMapPass) {\n                camera.update();\n\n                // update boundingBoxLastFrame\n                var bbox = scene.getBoundingBox();\n                bbox.applyTransform(camera.viewMatrix);\n                scene.viewBoundingBoxLastFrame.copy(bbox);\n\n                this.shadowMapPass.render(renderer, scene, camera, true);\n            }\n            this._frameBuffer.attach(\n                this.texture, _gl.COLOR_ATTACHMENT0,\n                _gl.TEXTURE_CUBE_MAP_POSITIVE_X + i\n            );\n            this._frameBuffer.bind(renderer);\n            renderer.render(scene, camera, true);\n            this._frameBuffer.unbind(renderer);\n        }\n    },\n    /**\n     * @param {clay.Renderer} renderer\n     */\n    dispose: function (renderer) {\n        this._frameBuffer.dispose(renderer);\n    }\n});\n\nexport default EnvironmentMapPass;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}